# CLAUDE.md — Divi Video Post Plugin

## Project Overview

A WordPress plugin that:
1. Registers a **"Video Post"** custom post type (CPT) with custom meta fields.
2. Registers a **Divi Extension** containing a custom **"Video Embed" Divi Builder Module** (Divi 4 compatible).
3. The module supports two modes: **dynamic** (reads the video URL from the current Video Post's meta) and **manual override** (URL entered directly in the module settings).

---

## Plugin Details

- **Plugin slug:** `divi-video-post`
- **Plugin file:** `divi-video-post.php`
- **Text domain:** `divi-video-post`
- **Minimum WordPress:** 6.0
- **Minimum PHP:** 8.0
- **Divi target:** Divi 4 (current stable) — uses the legacy `ET_Builder_Module` PHP class + React JSX component approach
- **No external dependencies** beyond what Divi ships with (React, etc.)

---

## File Structure

```
divi-video-post/
├── divi-video-post.php          # Main plugin bootstrap
├── CLAUDE.md
├── includes/
│   ├── class-video-post-cpt.php     # CPT registration + meta fields + meta box
│   └── class-divi-extension.php     # Divi Extension loader
├── modules/
│   └── VideoEmbed/
│       ├── VideoEmbed.php           # ET_Builder_Module PHP class
│       ├── VideoEmbed.jsx           # React component for builder UI
│       └── style.css                # Module frontend styles
├── assets/
│   └── admin/
│       └── meta-box.css             # Admin meta box styles (optional)
└── build/                           # Compiled JS output (generated by yarn/npm)
    └── divi-video-post.min.js
```

> **Note:** The `build/` directory is generated. Do not edit files there directly. Source JSX lives in `modules/VideoEmbed/VideoEmbed.jsx`.

---

## Custom Post Type: Video Post

**Registered slug:** `video_post`

### Meta Fields (all stored via `register_post_meta` + custom meta box)

| Meta Key | Type | Description |
|---|---|---|
| `_video_url` | `string` | YouTube or Vimeo URL (full URL) |
| `_video_thumbnail` | `integer` | Attachment ID for poster/thumbnail image |
| `_video_description` | `string` | Optional rich description (textarea) |

**Taxonomy:** `video_category` (hierarchical, like categories) and use the built-in `post_tag` taxonomy as well.

### CPT Args to note
- `show_in_rest: true` — enables Gutenberg & REST API
- `supports: ['title', 'editor', 'thumbnail', 'excerpt', 'custom-fields']`
- `public: true`
- `has_archive: true`
- Rewrite slug: `video-posts`

### Meta Registration
All meta keys must be registered with `register_post_meta()` so they're exposed via the REST API and available to `get_post_meta()` in the module's `render()` method.

---

## Divi Extension

The extension is loaded via `divi_extensions_init` action hook. The extension class extends `DiviExtension` and points Divi at the `modules/` directory.

**Extension name:** `divi-video-post`  
**Extension slug:** `divi_video_post`  
**Module directory:** `modules/`

The extension must be initialized only when Divi Builder is active (check for `class_exists('ET_Builder_Module')`).

---

## Divi Module: VideoEmbed

### PHP Class (`ET_Builder_Module`)

**Module slug:** `et_pb_video_embed`  
**Class name:** `ET_Builder_VideoEmbed`

#### Fields (`get_fields()`)

| Field Name | Type | Description |
|---|---|---|
| `video_mode` | `select` | `'dynamic'` (from post meta) or `'manual'` (entered below). Default: `'dynamic'` |
| `manual_video_url` | `text` | URL field shown only when `video_mode === 'manual'`. Hidden via `show_if`. |
| `video_ratio` | `select` | Aspect ratio: `'16:9'` (default), `'4:3'`, `'1:1'` |
| `show_thumbnail_fallback` | `yes_no_button` | Show CPT thumbnail as poster before play (default: `on`) |

Advanced fields (background, spacing, borders, etc.) are inherited automatically from Divi.

#### `render()` method logic

1. Get `$video_mode` from `$this->props`.
2. If `dynamic`: call `get_post_meta(get_the_ID(), '_video_url', true)` to retrieve the URL.
3. If `manual`: use `$this->props['manual_video_url']`.
4. Parse the URL to detect YouTube vs. Vimeo and build the correct `<iframe>` embed URL:
   - **YouTube:** `https://www.youtube.com/embed/{VIDEO_ID}?rel=0`
   - **Vimeo:** `https://player.vimeo.com/video/{VIDEO_ID}`
5. Wrap in a responsive ratio container div using CSS padding-bottom trick.
6. If `show_thumbnail_fallback === 'on'` and in dynamic mode, get the post thumbnail URL and set it as a `style="background-image:..."` on the wrapper.
7. Return the HTML string.

#### URL Parsing Helpers

Implement a private `parse_video_url(string $url): array` method that returns:
```php
['platform' => 'youtube'|'vimeo'|'unknown', 'id' => 'VIDEO_ID']
```

YouTube patterns to handle:
- `youtube.com/watch?v=ID`
- `youtu.be/ID`
- `youtube.com/embed/ID`

Vimeo patterns to handle:
- `vimeo.com/ID`
- `player.vimeo.com/video/ID`

---

### React/JSX Component (`VideoEmbed.jsx`)

- Extend `window.ET_Builder.api.module.ET_Builder_Module_Fields_Settings`
- Implement a `render()` method that shows a live preview iframe inside the builder using the URL from props.
- When `video_mode === 'dynamic'`, show a placeholder message in the builder (e.g., *"Video will load from post meta on the frontend"*) since the builder cannot resolve post meta dynamically.
- When `video_mode === 'manual'` and a URL is provided, render the actual iframe embed preview.
- The `show_if` conditional for `manual_video_url` field must be declared on the PHP field definition using `'show_if' => ['video_mode' => 'manual']`.

---

## Build Process

The JSX must be compiled. Use the Divi Extension's built-in npm/yarn build pipeline:

```bash
# Install dependencies (run once)
yarn install

# Development (watches for changes)
yarn start

# Production build
yarn build
```

The compiled output goes to `build/divi-video-post.min.js` and is enqueued by the Divi Extension automatically.

> **Do not commit `node_modules/`**. Do commit the `build/` directory so the plugin works without a build step for end users.

---

## Key Implementation Notes

### Divi 4 Module Registration
- PHP class must extend `ET_Builder_Module` directly.
- Register the module class on `et_builder_ready` action hook.
- The module category should be `'et_pb_media'` so it appears in the Media section of the builder.

### Dynamic Mode in Theme Builder
When used in Divi Theme Builder on a `video_post` single template, `get_the_ID()` resolves correctly. If used outside that context in dynamic mode, handle the case where `_video_url` is empty — render nothing or a placeholder div with a CSS class `dvp-no-video`.

### Responsive Embeds
Use the CSS padding-bottom ratio trick for responsive iframes:
```css
.dvp-video-wrapper {
  position: relative;
  width: 100%;
  overflow: hidden;
}
.dvp-video-wrapper iframe {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  border: 0;
}
```
Apply ratio class based on `video_ratio` prop: `.dvp-ratio-16x9` (padding-bottom: 56.25%), `.dvp-ratio-4x3` (75%), `.dvp-ratio-1x1` (100%).

### Security
- Always `esc_url()` the video URL before embedding.
- Sanitize meta fields with `sanitize_url()` on save.
- Use `wp_kses()` or just avoid user-generated HTML in iframe attributes.
- Nonce-verify the meta box save.

### Divi Extension Autoloading
The `DiviExtension` class handles JS/CSS enqueueing automatically. Ensure the extension's `__DIR__` points correctly to the plugin root so it can find `build/` and `modules/`.

---

## Development Checklist

- [ ] Register CPT (`video_post`) with correct args
- [ ] Register `video_category` taxonomy
- [ ] Register post meta with `register_post_meta()`
- [ ] Build admin meta box for `_video_url`, `_video_thumbnail`, `_video_description`
- [ ] Scaffold Divi Extension class
- [ ] Build `VideoEmbed.php` module class with all fields
- [ ] Implement `parse_video_url()` helper
- [ ] Implement `render()` with dynamic/manual modes
- [ ] Build `VideoEmbed.jsx` React component with builder preview logic
- [ ] Write `style.css` with ratio classes
- [ ] Compile JS (`yarn build`)
- [ ] Test dynamic mode on Video Post single template in Divi Theme Builder
- [ ] Test manual mode on a regular page
- [ ] Test empty URL edge cases
